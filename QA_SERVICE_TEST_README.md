# QAService 功能测试说明

## 概述

本测试套件为 `QAService` 提供了全面的功能测试，涵盖了不同条件下的问答服务功能。测试使用模拟数据，不依赖真实的数据库连接，确保测试的稳定性和可重复性。

## 测试用例

### 1. 基础单次问答功能 (`test_single_ask_basic`)
- **测试内容**: 测试基本的单次问答功能
- **测试数据**: 使用"北上广深的积分入学政策是什么？"问题
- **验证点**: 
  - 返回结果包含answer、reference、prompt、created_at字段
  - 答案内容包含"北上广深"关键词

### 2. 带关键词提取的单次问答 (`test_single_ask_with_keyword_extraction`)
- **测试内容**: 测试启用关键词提取功能的单次问答
- **测试数据**: 使用"龙岗区积分入学需要多少积分？"问题
- **验证点**:
  - 答案包含"龙岗区"和"100分"等关键信息
  - 关键词提取功能正常工作

### 3. 基础多轮对话功能 (`test_chat_basic`)
- **测试内容**: 测试基本的多轮对话功能
- **测试数据**: 使用"如何计算自己的积分有多少？"问题
- **验证点**:
  - 答案包含"积分计算"、"基础分"、"加分项"等关键词
  - 多轮对话处理正常

### 4. 带目标语言转换的多轮对话 (`test_chat_with_target_language`)
- **测试内容**: 测试启用目标语言转换功能的多轮对话
- **测试数据**: 使用"深圳和上海积分计算差异是什么？"问题，目标语言为英文
- **验证点**:
  - 答案包含"Shenzhen"、"Shanghai"、"differences"等英文关键词
  - 语言转换功能正常工作

### 5. 带Tavily外部搜索的多轮对话 (`test_chat_with_tavily_search`)
- **测试内容**: 测试启用Tavily外部搜索功能的多轮对话
- **测试数据**: 使用"最新的积分政策有什么变化？"问题
- **验证点**:
  - 答案包含"2024年"、"政策"、"调整"等关键词
  - 外部搜索功能正常工作

### 6. 带知识图谱搜索的多轮对话 (`test_chat_with_kg_search`)
- **测试内容**: 测试启用知识图谱搜索功能的多轮对话
- **测试数据**: 使用"积分政策相关的法律法规有哪些？"问题
- **验证点**:
  - 答案包含"法律法规"、"居住证暂行条例"、"积分入户管理办法"等关键词
  - 知识图谱搜索功能正常工作

### 7. 知识库不存在的错误处理 (`test_error_handling_no_kb`)
- **测试内容**: 测试当知识库不存在时的错误处理
- **测试数据**: 使用不存在的知识库ID
- **验证点**:
  - 返回错误信息包含"抱歉"和"错误"关键词
  - 错误处理机制正常工作

### 8. 没有找到相关知识的错误处理 (`test_error_handling_no_knowledge`)
- **测试内容**: 测试当没有找到相关知识时的错误处理
- **测试数据**: 使用完全不相关的问题
- **验证点**:
  - 返回"抱歉，没有找到相关信息"的错误信息
  - 空结果处理机制正常工作

### 9. SQL查询功能 (`test_use_sql_functionality`)
- **测试内容**: 测试SQL查询功能
- **测试数据**: 使用结构化数据查询
- **验证点**:
  - 返回结果包含"入户政策"和"入学政策"信息
  - SQL查询功能正常工作

### 10. 修复错误引用格式功能 (`test_repair_bad_citation_formats`)
- **测试内容**: 测试引用格式修复功能
- **测试数据**: 包含多种错误引用格式的文本
- **验证点**:
  - 所有引用格式都被正确转换为标准格式
  - 引用索引被正确提取

## 测试数据

### 知识库信息
- **ID**: `83c9f0b5d2dc472e81bf6d5da382d2a1`
- **名称**: 积分政策知识库
- **租户ID**: `test_tenant`

### 文档信息
1. **北上广深积分入户条件.docx**
   - ID: `eba5baea-dc61-4499-be59-fb599eea7ac5`
   - 类别: 入户政策
   - 地区: 北上广深

2. **龙岗福田积分入学.docx**
   - ID: `3036e8d1-42e9-4fc9-a505-c6b26730a521`
   - 类别: 入学政策
   - 地区: 龙岗福田

## 运行测试

### 方法1: 使用测试运行脚本
```bash
python run_qa_tests.py
```

### 方法2: 使用pytest
```bash
pytest test_qa_service.py -v
```

### 方法3: 直接运行测试文件
```bash
python test_qa_service.py
```

## 测试配置

### 依赖项
- `pytest`: 测试框架
- `asyncio`: 异步测试支持
- `unittest.mock`: 模拟对象支持

### 模拟对象
测试使用以下模拟对象：
- `AsyncMock`: 模拟异步数据库会话
- `MagicMock`: 模拟LLM模型
- `patch`: 模拟外部依赖

## 注意事项

1. **流式响应**: 本测试套件不测试流式响应功能，专注于非流式模式
2. **真实数据**: 所有测试都使用模拟数据，不依赖真实的数据库或外部服务
3. **异步支持**: 所有测试都使用异步模式，确保与生产环境一致
4. **错误处理**: 测试包含各种错误情况的处理验证

## 扩展测试

如需添加新的测试用例，请遵循以下模式：

1. 创建新的测试方法，以 `test_` 开头
2. 使用 `@pytest.mark.asyncio` 装饰器标记异步测试
3. 使用适当的模拟对象和补丁
4. 添加清晰的断言验证
5. 在测试方法中添加日志输出

## 故障排除

### 常见问题
1. **导入错误**: 确保项目根目录在Python路径中
2. **异步错误**: 确保使用 `asyncio.run()` 运行异步测试
3. **模拟错误**: 检查模拟对象的配置是否正确

### 调试技巧
1. 启用详细日志输出
2. 检查模拟对象的返回值
3. 验证断言条件
4. 使用断点调试
